# INBOX-Run.ps1
$ErrorActionPreference = 'Stop'
. "D:\CHECHA_CORE\INBOX\INBOX-Config.ps1"
$ts = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
$day = Get-Date -Format 'yyyyMMdd'

# 1) Згенерувати артефакти (викликає ваш існуючий генератор)
#    Додайте тут ваші параметри (-WithChart тощо), якщо потрібно.
pwsh -NoProfile -ExecutionPolicy Bypass `
  -File "D:\CHECHA_CORE\INBOX\Generate-PublicArtifacts.ps1" | Out-Null

# 2) Self-check (стопимо оновлення панелі, якщо CRITICAL)
& "D:\CHECHA_CORE\INBOX\INBOX-SelfCheck.ps1" -Quiet
$exitCode = $LASTEXITCODE

# 3) Оновити STATUS.json
$status = [ordered]@{
  timestamp = $ts
  artifacts = @{
    health      = Test-Path $INBOX.HealthPath
    manifest    = Test-Path $INBOX.ManifestPath
    public_flow = Test-Path $INBOX.PublicFlowPath
  }
  selfcheck = @{
    exit_code = $exitCode
    short_md  = $INBOX.SelfCheckShort
  }
}
$status | ConvertTo-Json -Depth 5 | Out-File -FilePath $INBOX.StatusJson -Encoding UTF8

# 4) Якщо self-check OK — зібрати коротку панель; інакше попередження
if ($exitCode -eq 0) {
  $health  = (Get-Content $INBOX.HealthPath    -ErrorAction SilentlyContinue) -join "`n"
  $flow    = (Get-Content $INBOX.PublicFlowPath -ErrorAction SilentlyContinue) -join "`n"

  $panel = @()
  $panel += "# INBOX Panel — $ts"
  $panel += ""
  $panel += "### Короткий стан (з Health)"
  $panel += ($health | Select-String -Pattern '^\- ' -SimpleMatch | Select-Object -First 10 | ForEach-Object { $_.ToString() })
  $panel += ""
  $panel += "### Потік (перші кроки)"
  $panel += ($flow | Select-Object -First 20)
  $panel += ""
  $panel += "_Повні версії: `health.md`, `public_flow.md`, `manifest.csv` у `C12_KNOWLEDGE\\MD_INBOX`._"

  # === Quick Start link (idempotent) ===
../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md = "../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md"
- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md) = "- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md)"

if (-not (D:\CHECHA_CORE\C06_FOCUS\INBOX_PANEL.md### Швидкі посилання- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md)- [Повний health](../C12_KNOWLEDGE/MD_INBOX/health.md)- [Потік public_flow](../C12_KNOWLEDGE/MD_INBOX/public_flow.md)- [Інвентар manifest.csv](../C12_KNOWLEDGE/MD_INBOX/manifest.csv)### Швидкі посилання- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md) -match '^### Швидкі посилання
} else {
  $warn = @()
  $warn += "# INBOX Panel — $ts"
  $warn += "❌ Панель не оновлена: критичні артефакти відсутні."
  $warn += ""
  $warn += (Get-Content $INBOX.SelfCheckShort)
  $warn -join "`r`n" | Out-File -FilePath $INBOX.PanelPath -Encoding UTF8
}

# 5) Додати запис у LOG
Add-Content -Path $INBOX.LogPath -Value ("- [{0}] Run complete (selfcheck={1})" -f $ts, $exitCode)
Write-Host "INBOX: done (selfcheck=$exitCode)"
)) {
    D:\CHECHA_CORE\C06_FOCUS\INBOX_PANEL.md### Швидкі посилання- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md)- [Повний health](../C12_KNOWLEDGE/MD_INBOX/health.md)- [Потік public_flow](../C12_KNOWLEDGE/MD_INBOX/public_flow.md)- [Інвентар manifest.csv](../C12_KNOWLEDGE/MD_INBOX/manifest.csv)### Швидкі посилання- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md) += "### Швидкі посилання"
    if (-not (D:\CHECHA_CORE\C06_FOCUS\INBOX_PANEL.md### Швидкі посилання- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md)- [Повний health](../C12_KNOWLEDGE/MD_INBOX/health.md)- [Потік public_flow](../C12_KNOWLEDGE/MD_INBOX/public_flow.md)- [Інвентар manifest.csv](../C12_KNOWLEDGE/MD_INBOX/manifest.csv)### Швидкі посилання- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md) -match [regex]::Escape(- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md)))) { D:\CHECHA_CORE\C06_FOCUS\INBOX_PANEL.md### Швидкі посилання- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md)- [Повний health](../C12_KNOWLEDGE/MD_INBOX/health.md)- [Потік public_flow](../C12_KNOWLEDGE/MD_INBOX/public_flow.md)- [Інвентар manifest.csv](../C12_KNOWLEDGE/MD_INBOX/manifest.csv)### Швидкі посилання- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md) += - [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md) }
} else {
    if (-not (D:\CHECHA_CORE\C06_FOCUS\INBOX_PANEL.md### Швидкі посилання- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md)- [Повний health](../C12_KNOWLEDGE/MD_INBOX/health.md)- [Потік public_flow](../C12_KNOWLEDGE/MD_INBOX/public_flow.md)- [Інвентар manifest.csv](../C12_KNOWLEDGE/MD_INBOX/manifest.csv)### Швидкі посилання- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md) -match [regex]::Escape(- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md)))) { D:\CHECHA_CORE\C06_FOCUS\INBOX_PANEL.md### Швидкі посилання- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md)- [Повний health](../C12_KNOWLEDGE/MD_INBOX/health.md)- [Потік public_flow](../C12_KNOWLEDGE/MD_INBOX/public_flow.md)- [Інвентар manifest.csv](../C12_KNOWLEDGE/MD_INBOX/manifest.csv)### Швидкі посилання- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md) += - [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md) }
}

 = @(
    "- [Повний health](../C12_KNOWLEDGE/MD_INBOX/health.md)",
    "- [Потік public_flow](../C12_KNOWLEDGE/MD_INBOX/public_flow.md)",
    "- [Інвентар manifest.csv](../C12_KNOWLEDGE/MD_INBOX/manifest.csv)"
)
foreach (- [Інвентар manifest.csv](../C12_KNOWLEDGE/MD_INBOX/manifest.csv) in ) {
    if (-not (D:\CHECHA_CORE\C06_FOCUS\INBOX_PANEL.md### Швидкі посилання- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md)- [Повний health](../C12_KNOWLEDGE/MD_INBOX/health.md)- [Потік public_flow](../C12_KNOWLEDGE/MD_INBOX/public_flow.md)- [Інвентар manifest.csv](../C12_KNOWLEDGE/MD_INBOX/manifest.csv)### Швидкі посилання- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md) -match [regex]::Escape(- [Інвентар manifest.csv](../C12_KNOWLEDGE/MD_INBOX/manifest.csv)))) { D:\CHECHA_CORE\C06_FOCUS\INBOX_PANEL.md### Швидкі посилання- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md)- [Повний health](../C12_KNOWLEDGE/MD_INBOX/health.md)- [Потік public_flow](../C12_KNOWLEDGE/MD_INBOX/public_flow.md)- [Інвентар manifest.csv](../C12_KNOWLEDGE/MD_INBOX/manifest.csv)### Швидкі посилання- [INBOX Quick Start](../C12_KNOWLEDGE/MD_INBOX/INBOX_Quick_Start.md) += - [Інвентар manifest.csv](../C12_KNOWLEDGE/MD_INBOX/manifest.csv) }
}
# === /Quick Start link ===
. "D:\CHECHA_CORE\INBOX\INBOX-PanelLinks.ps1"
$panel = Add-InboxQuickLinks -Panel $panel
$panel -join "`r`n" | Out-File -FilePath $INBOX.PanelPath -Encoding UTF8
} else {
  $warn = @()
  $warn += "# INBOX Panel — $ts"
  $warn += "❌ Панель не оновлена: критичні артефакти відсутні."
  $warn += ""
  $warn += (Get-Content $INBOX.SelfCheckShort)
  $warn -join "`r`n" | Out-File -FilePath $INBOX.PanelPath -Encoding UTF8
}

# 5) Додати запис у LOG
Add-Content -Path $INBOX.LogPath -Value ("- [{0}] Run complete (selfcheck={1})" -f $ts, $exitCode)
Write-Host "INBOX: done (selfcheck=$exitCode)"




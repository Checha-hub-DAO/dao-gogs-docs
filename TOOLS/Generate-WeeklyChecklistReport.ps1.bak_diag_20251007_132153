<#
–°—É–º—É—î CHECKLIST_YYYY-MM-DD.md –∑–∞ —Ç–∏–∂–¥–µ–Ω—å —ñ —Ñ–æ—Ä–º—É—î WEEKLY_CHECKLIST_YYYY-Www.md
–î–∂–µ—Ä–µ–ª–æ: D:\CHECHA_CORE\C06_FOCUS
–î–æ–¥–∞—î: —Å–µ–∫—Ü—ñ—é —Ä–µ—Ñ–ª–µ–∫—Å—ñ—ó, carry-over –∑ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –¥–Ω—è, –º—ñ–∫—Ä–æ-KPI (avg/day, share DONE, median, best/worst, DONE-streak)
#>
param(
  [string]$FocusDir = "D:\CHECHA_CORE\C06_FOCUS",
  [switch]$WriteRestoreLog = $true,
  [string]$RestoreLogPath = "D:\CHECHA_CORE\C06_FOCUS\FOCUS_RestoreLog.md",

  # –ö—ñ–Ω–µ—Ü—å —Ç–∏–∂–Ω—è (–¥–∞—Ç–∞). –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º ‚Äî —Å—å–æ–≥–æ–¥–Ω—ñ.
  [datetime]$WeekEnd = (Get-Date),

  # –¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Ç–∏–∂–Ω—è (–¥–Ω—ñ–≤). –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º 7 (–ü–ù‚Äì–ù–î, —è–∫—â–æ –∑–∞–ø—É—Å–∫ —É –Ω–µ–¥—ñ–ª—é).
  [int]$Days = 7,

  # –í–º–∏–∫–∞—î –¥–æ–¥–∞–≤–∞–Ω–Ω—è —à–∞–±–ª–æ–Ω—É —Ä–µ—Ñ–ª–µ–∫—Å—ñ—ó
  [switch]$IncludeReflection = $true,

  # –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –≤–∏—Ç—è–≥–Ω—É—Ç–∏ —Ç–æ–ø-–Ω–µ–≤–∏–∫–æ–Ω–∞–Ω—ñ –ø—É–Ω–∫—Ç–∏ –∑ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –¥–Ω—è (–¥–æ N)
  [int]$CarryOverTop = 5
)
$ErrorActionPreference = "Stop"

function Get-ChecklistStats {
  param([string]$Path)
  if (-not (Test-Path $Path)) { return $null }
  $lines = Get-Content -Path $Path -Encoding UTF8

  # –ó—á–∏—Ç–∞—Ç–∏ Status (–ø–µ—Ä—à—ñ 5 —Ä—è–¥–∫—ñ–≤)
  $status = "OPEN"
  for ($i=0; $i -lt [Math]::Min(5,$lines.Count); $i++) {
    if ($lines[$i] -match '^\s*(?:>\s*)?Status:\s*(OPEN|IN-PROGRESS|DONE)\s*$') {
      $status = $Matches[1]; break
    }
  }

  # –ü–æ—Ä–∞—Ö—É–≤–∞—Ç–∏ —á–µ–∫–±–æ–∫—Å–∏
  $total = 0; $done = 0; $todo = 0
  foreach ($l in $lines) {
    if ($l -match '^\s*-\s*\[\s*\S?\s*\]\s+') {
      $total++
      if ($l -match '^\s*-\s*\[\s*x\s*\]\s+') { $done++ } else { $todo++ }
    }
  }
  $pct = if ($total -gt 0) { [math]::Round(($done*100.0)/$total,1) } else { 0 }

  # –ù–µ–≤–∏–∫–æ–Ω–∞–Ω—ñ –ø—É–Ω–∫—Ç–∏ (–¥–ª—è CarryOver)
  $openItems = @()
  foreach ($l in $lines) {
    if ($l -match '^\s*-\s*\[\s\]\s+(.+)$') { $openItems += $Matches[1].Trim() }
  }

  # –í–∏—Ç—è–≥–Ω–µ–º–æ –¥–∞—Ç—É –∑ –Ω–∞–∑–≤–∏
  $file = Split-Path $Path -Leaf
  $dateStr = $null
  if ($file -match 'CHECKLIST_(\d{4})-(\d{2})-(\d{2})\.md') {
    $dateStr = "{0}-{1}-{2}" -f $Matches[1],$Matches[2],$Matches[3]
  }

  return [pscustomobject]@{
    File      = $file
    DateStr   = $dateStr
    Status    = $status
    Total     = $total
    Done      = $done
    Todo      = $todo
    Pct       = $pct
    OpenItems = $openItems
    RawLines  = $lines
  }
}

function Get-Median {
  param([double[]]$values)
  if (-not $values -or $values.Count -eq 0) { return 0.0 }
  $sorted = $values | Sort-Object
  $n = $sorted.Count
  if ($n % 2 -eq 1) {
    return [double]$sorted[ [int]([math]::Floor($n/2)) ]
  } else {
    $a = [double]$sorted[ ($n/2)-1 ]
    $b = [double]$sorted[ $n/2 ]
    return [math]::Round( ($a + $b)/2.0, 1 )
  }
}

$end   = $WeekEnd.Date
$start = $end.AddDays(-($Days-1))

# –ü—ñ–¥—ñ–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª–∏ –∑–∞ –º–∞—Å–∫–æ—é —Ç–∞ –¥–∞—Ç–æ—é –≤ –Ω–∞–∑–≤—ñ
$files = Get-ChildItem $FocusDir -Filter "CHECKLIST_*.md" -File |
         Where-Object {
           if ($_ -match 'CHECKLIST_(\d{4})-(\d{2})-(\d{2})\.md') {
            $d = Get-Date ("$($Matches[1])-$($Matches[2])-$($Matches[3])")
            ($d -ge $start) -and ($d -le $end)
           } else { $false }
         } | Sort-Object Name

$rows = @()
foreach ($f in $files) { $rows += Get-ChecklistStats -Path $f.FullName }

# –ü—ñ–¥—Å—É–º–∫–∏
$daysCount = $rows.Count
$sumTotal  = ($rows | Measure-Object -Property Total -Sum).Sum
$sumDone   = ($rows | Measure-Object -Property Done  -Sum).Sum
$sumTodo   = ($rows | Measure-Object -Property Todo  -Sum).Sum
$avgPct    = if ($daysCount -gt 0) { [math]::Round(($rows | Measure-Object -Property Pct -Average).Average, 1) } else { 0 }

# --- –ú–Ü–ö–†–û-KPI ---
$avgItemsPerDay = if ($daysCount -gt 0) { [math]::Round($sumTotal / $daysCount, 1) } else { 0 }
$doneDays       = ($rows | Where-Object { $_.Status -eq 'DONE' }).Count
$doneSharePct   = if ($daysCount -gt 0) { [math]::Round(($doneDays*100.0)/$daysCount,1) } else { 0 }
$medianPct      = Get-Median ($rows | ForEach-Object { [double]$_.Pct })
# best/worst
$best = $null; $worst = $null
if ($rows.Count -gt 0) {
  $best  = $rows | Sort-Object Pct -Descending | Select-Object -First 1
  $worst = $rows | Sort-Object Pct | Select-Object -First 1
}
# DONE-streak (–ø–æ—Ç–æ—á–Ω–∏–π, –≤—ñ–¥ –∫—ñ–Ω—Ü—è —Ç–∏–∂–Ω—è –Ω–∞–∑–∞–¥)
$streak = 0
for ($d=$end; $d -ge $start; $d=$d.AddDays(-1)) {
  $hit = $rows | Where-Object { $_.DateStr -eq $d.ToString('yyyy-MM-dd') } | Select-Object -First 1
  if ($null -ne $hit -and $hit.Status -eq 'DONE') { $streak++ } else { break }
}

# –ù–∞–∑–≤–∞ —Ñ–∞–π–ª—É –∑–∞ ISO-—Ç–∏–∂–Ω–µ–º
$iso = [System.Globalization.ISOWeek]::GetWeekOfYear($end)
$year= $end.Year
$weeklyPath = Join-Path $FocusDir ("WEEKLY_CHECKLIST_{0}-W{1:00}.md" -f $year, $iso)

# Markdown-—Ç–∞–±–ª–∏—Ü—è –ø–æ –¥–Ω—è—Ö
$lines = @()
$lines += "# –¢–∏–∂–Ω–µ–≤–∏–π –∑–≤—ñ—Ç —á–µ–∫-–ª–∏—Å—Ç—ñ–≤ ($($start.ToString('yyyy-MM-dd')) ‚Üí $($end.ToString('yyyy-MM-dd')))"
$lines += ""
$lines += "| –î–∞—Ç–∞ | –§–∞–π–ª | –°—Ç–∞—Ç—É—Å | –í—Å—å–æ–≥–æ | –í–∏–∫–æ–Ω–∞–Ω–æ | –ó–∞–ª–∏—à–∏–ª–æ—Å—å | –ü—Ä–æ–≥—Ä–µ—Å |"
$lines += "|---|---|---|---:|---:|---:|---:|"

for ($d=$start; $d -le $end; $d=$d.AddDays(1)) {
  $key = $rows | Where-Object { $_.DateStr -eq $d.ToString('yyyy-MM-dd') } | Select-Object -First 1
  if ($null -ne $key) {
    $lines += "| {0} | `{1}` | {2} | {3} | {4} | {5} | {6}% |" -f `
      $d.ToString('yyyy-MM-dd'), $key.File, $key.Status, $key.Total, $key.Done, $key.Todo, $key.Pct
  } else {
    $lines += "| {0} | ‚Äî | ‚Äî | 0 | 0 | 0 | 0% |" -f $d.ToString('yyyy-MM-dd')
  }
}

$lines += ""
$lines += "## –ü—ñ–¥—Å—É–º–∫–∏ —Ç–∏–∂–Ω—è"
$lines += "- –î–Ω—ñ–≤ —É –∑–≤—ñ—Ç—ñ: **$daysCount**"
$lines += "- –°—É–º–∞ –ø—É–Ω–∫—Ç—ñ–≤: **$sumTotal**"
$lines += "- –í–∏–∫–æ–Ω–∞–Ω–æ –≤—Å—å–æ–≥–æ: **$sumDone**"
$lines += "- –ó–∞–ª–∏—à–∏–ª–æ—Å—å –≤—Å—å–æ–≥–æ: **$sumTodo**"
$lines += "- –°–µ—Ä–µ–¥–Ω—ñ–π –ø—Ä–æ–≥—Ä–µ—Å –∑–∞ –¥–µ–Ω—å: **$avgPct%**"
$lines += ""

# --- –ú–Ü–ö–†–û-KPI –ë–õ–û–ö ---
$lines += "## üìå –ú—ñ–∫—Ä–æ-KPI"
$lines += "| –ü–æ–∫–∞–∑–Ω–∏–∫ | –ó–Ω–∞—á–µ–Ω–Ω—è |"
$lines += "|---|---:|"
$lines += ("| –°–µ—Ä–µ–¥–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø—É–Ω–∫—Ç—ñ–≤/–¥–µ–Ω—å | {0} |" -f $avgItemsPerDay)
$lines += ("| –ß–∞—Å—Ç–∫–∞ –¥–Ω—ñ–≤ –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º DONE | {0}% ({1}/{2}) |" -f $doneSharePct, $doneDays, $daysCount)
$lines += ("| –ú–µ–¥—ñ–∞–Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—É | {0}% |" -f $medianPct)
if ($best)  { $lines += ("| –ù–∞–π–∫—Ä–∞—â–∏–π –¥–µ–Ω—å | {0} ‚Äî {1}% |" -f $best.DateStr,  $best.Pct) }
if ($worst) { $lines += ("| –ù–∞–π–≥—ñ—Ä—à–∏–π –¥–µ–Ω—å | {0} ‚Äî {1}% |" -f $worst.DateStr, $worst.Pct) }
$lines += ("| –ü–æ—Ç–æ—á–Ω–∏–π DONE-—Å—Ç—Ä—ñ–∫ (–¥–Ω—ñ–≤ –ø—ñ–¥—Ä—è–¥ –≤—ñ–¥ –∫—ñ–Ω—Ü—è) | {0} |" -f $streak)
$lines += ""

# ‚ú® –†–µ—Ñ–ª–µ–∫—Å—ñ—è (—à–∞–±–ª–æ–Ω)
if ($IncludeReflection) {
  $lastDay = $rows | Sort-Object DateStr -Descending | Select-Object -First 1
  $carry = @()
  if ($lastDay -and $lastDay.OpenItems.Count -gt 0) {
    $carry = $lastDay.OpenItems | Select-Object -First $CarryOverTop
  }

  $lines += "## ü™û –†–µ—Ñ–ª–µ–∫—Å—ñ—è —Ç–∏–∂–Ω—è (—à–∞–±–ª–æ–Ω)"
  $lines += "- **–©–æ —Å–ø—Ä–∞—Ü—é–≤–∞–ª–æ –¥–æ–±—Ä–µ:**"
  $lines += "  - ‚Ä¶"
  $lines += "- **–©–æ –∑–∞–≤–∞–¥–∏–ª–æ/–≥–∞–ª—å–º—É–≤–∞–ª–æ:**"
  $lines += "  - ‚Ä¶"
  $lines += "- **–ì–æ–ª–æ–≤–Ω–∏–π —Ñ–æ–∫—É—Å –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ç–∏–∂–Ω—è:**"
  if ($carry.Count -gt 0) {
    $lines += "  - (—á–µ—Ä–Ω–µ—Ç–∫–∞ –∑ –Ω–µ–≤–∏–∫–æ–Ω–∞–Ω–∏—Ö):"
    foreach ($c in $carry) { $lines += ("    - {0}" -f $c) }
  } else {
    $lines += "  - ‚Ä¶"
  }
  $lines += "- **–†–∏–∑–∏–∫–∏ / –±–ª–æ–∫–µ—Ä–∏:**"
  $lines += "  - ‚Ä¶"
  $lines += ""
}

$lines += "---"
$lines += "–°.–ß."

# –ó–∞–ø–∏—Å –∑–≤—ñ—Ç—É
$lines | Set-Content -Path $weeklyPath -Encoding utf8BOM
Write-Host "‚úÖ WEEKLY REPORT: $weeklyPath"

# –õ–æ–≥ —É RestoreLog
if ($WriteRestoreLog) {
  $stamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
  if (-not (Test-Path $RestoreLogPath)) {
    "# Restore Log ($($end.ToString('yyyy-MM-dd')))`n" | Set-Content -Path $RestoreLogPath -Encoding utf8BOM
  }
  $line = "- [$stamp] Weekly report: $(Split-Path $weeklyPath -Leaf) | Days={0} | Total={1} | Done={2} | Todo={3} | AvgPct={4}% | DoneShare={5}% | Median={6}% | Streak={7}" -f `
          $daysCount, $sumTotal, $sumDone, $sumTodo, $avgPct, $doneSharePct, $medianPct, $streak
  Add-Content -Path $RestoreLogPath -Value $line -Encoding utf8BOM
  Write-Host "üß≠ RestoreLog –æ–Ω–æ–≤–ª–µ–Ω–æ"
}
